<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Team VIBE</title>
  <meta name="description" content="Vote for the next Team VIBE activity by watching the reels/shorts and casting your vote." />
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Rubik:wght@400;600;800&family=Fugaz+One&family=Teko:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{ --bg:#0b1020; --card:#121733; --ink:#e7ecff; --muted:#9aa3c7; }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{ margin:0; font-family:Rubik,system-ui,Segoe UI,Roboto,Helvetica,Arial; color:var(--ink);
      background:radial-gradient(1200px 800px at 10% -10%, #1a2050, transparent 50%),
                 radial-gradient(1200px 800px at 110% 10%, #35206a, transparent 50%),
                 linear-gradient(180deg,#0b1020,#0b1020 60%, #0f1630); }
    header{position:sticky; top:0; z-index:10; background:linear-gradient(180deg, rgba(15,22,48,.85), rgba(15,22,48,.35)); border-bottom:1px solid rgba(255,255,255,.08); -webkit-backdrop-filter:saturate(1.2) blur(6px); backdrop-filter:saturate(1.2) blur(6px)}
    .wrap{max-width:1200px; margin:0 auto; padding:16px}
    .brand{display:flex; align-items:center; gap:16px; justify-content:space-between; flex-wrap:wrap}
    .title{font-family:"Fugaz One", cursive; line-height:.9; margin:6px 0; font-size: clamp(100px, 14vw, 160px); letter-spacing:2px; text-transform:uppercase; background: conic-gradient(from 0deg, #8be9ff, #ffd166, #95ff87, #ff7eb6, #8be9ff); background-size: 200% 200%; -webkit-background-clip: text; background-clip:text; color: transparent; filter: drop-shadow(0 8px 30px rgba(124,247,255,.25)); animation: hue 8s linear infinite, floaty 5s ease-in-out infinite}
    @keyframes hue{0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}}
    @keyframes floaty{0%,100%{transform:translateY(0)}50%{transform:translateY(-6px)}}

    /* Top stats */
    .stats{display:grid; gap:10px; grid-template-columns:1fr; margin-top:6px}
    .bar{display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center}
    .bar .name{display:flex; align-items:center; gap:10px; font-family:Teko, Rubik, system-ui; letter-spacing:.4px; font-size:22px}
    .bar .badge{width:14px; height:14px; border-radius:4px; opacity:.9}
    .track{height:14px; background:rgba(255,255,255,.08); border:1px solid rgba(255,255,255,.1); border-radius:999px; overflow:hidden}
    .fill{height:100%; width:0%; background:linear-gradient(90deg, var(--c1), var(--c2)); box-shadow:0 0 20px rgba(255,255,255,.15) inset; transition: width .7s cubic-bezier(.22,.61,.36,1);
      position:relative}
    .fill::after{content:""; position:absolute; inset:0; background:linear-gradient(120deg, rgba(255,255,255,.25), rgba(255,255,255,0) 60%); transform:skewX(-20deg) translateX(-100%); animation: shimmer 2.2s infinite}
    @keyframes shimmer{to{transform:skewX(-20deg) translateX(120%)}}
    .count{font-weight:800}

    /* Grid of reels */
    .grid{display:grid; gap:16px; grid-template-columns:repeat(3, 1fr)}
    @media(max-width:1100px){.grid{grid-template-columns:repeat(2,1fr)}}
    @media(max-width:700px){.grid{grid-template-columns:1fr}}

    .card{background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02)); border:1px solid rgba(255,255,255,.08); border-radius:18px; padding:14px; box-shadow:0 20px 60px rgba(0,0,0,.25)}
    .card h3{margin:2px 0 10px; font-size:22px; font-family:Teko, Rubik}
    .nameColor1{color:#8be9ff}.nameColor2{color:#95ff87}.nameColor3{color:#ffd166}.nameColor4{color:#ff7eb6}
    .reel{position:relative; width:100%; aspect-ratio:9/16; border-radius:14px; overflow:hidden; background:#0a0f24; border:1px solid rgba(255,255,255,.1)}
    .reel iframe, .reel blockquote{position:absolute; inset:0; width:100%; height:100%}
    .row{display:flex; gap:8px; margin-top:10px; align-items:center}
    .row input{flex:1; min-width:120px; padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0d1330; color:var(--ink)}
    .btn{appearance:none; border:0; border-radius:12px; padding:10px 14px; font-weight:700; cursor:pointer; color:#0b1020; background:linear-gradient(135deg,#7cf7ff,#95ff87); box-shadow:0 10px 30px rgba(124,247,255,.25); transition:.2s transform}
    .btn:hover{transform:translateY(-1px)}
    .btn.ghost{color:var(--ink); background:transparent; border:1px solid rgba(255,255,255,.12)}
    .btn.warn{background:linear-gradient(135deg,#ff7eb6,#ffd166); color:#0b1020}

    .subtle{color:var(--muted); font-size:13px}
    .footer{margin:20px 0 60px; text-align:center; color:var(--muted); font-size:12px}

    .orbit{position:fixed; pointer-events:none; inset:0; overflow:hidden}
    .orb{position:absolute; width:10px; height:10px; border-radius:2px; opacity:.7; animation: drift linear infinite}
    @keyframes drift{to{transform:translate3d(var(--dx), 100vh, 0) rotate(720deg)}}

    /* Admin panel */
    .admin{margin:12px 0 20px; padding:12px; border-radius:16px; border:1px dashed rgba(255,255,255,.2); background:rgba(255,255,255,.04)}
    .admGrid{display:grid; gap:8px; grid-template-columns:repeat(2,1fr)}
    @media(max-width:900px){.admGrid{grid-template-columns:1fr}}
    .admRow{display:flex; gap:8px; align-items:center; justify-content:space-between; padding:8px 10px; border-radius:10px; background:rgba(255,255,255,.04)}
  </style>
</head>
<body>
  <header>
    <div class="wrap brand">
      <div class="title">Team VIBE</div>
      <div class="stats" id="topStats"></div>
    </div>
  </header>

  <div class="wrap" style="margin-top:10px">
    <div id="adminPanel" class="admin" style="display:none"></div>

    <p class="subtle">Vote for your favorite reels/shorts. You can vote for <b>multiple different items</b>, but only once per item from your device + name.</p>
    <div class="grid" id="reelsGrid"></div>

    <div id="liveFeed" class="card" style="margin:10px 0; padding:12px;">
      <div style="font-weight:800; margin-bottom:6px">üì£ Live votes (latest 10)</div>
      <div id="feedBody" class="subtle">No votes yet.</div>
    </div>

    <p class="footer">Built for employee engagement & fun ‚úåÔ∏è ‚Äì Team VIBE</p>
  </div>

  <div class="orbit" aria-hidden="true" id="orbit"></div>

  <script async src="https://www.instagram.com/embed.js" crossorigin="anonymous"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.2/firebase-auth-compat.js"></script>

  <script>
  (function(){ 'use strict';
    // ===== Admin code (change this to your secret) =====
    const ADMIN_CODE = 'VIBE-SECRET-1234';
    const qp = new URLSearchParams(location.search);
    let isAdmin = qp.get('admin')==='1' && (localStorage.getItem('tv_admin_ok')==='1' || prompt('Enter admin code')===ADMIN_CODE);
    if(isAdmin) localStorage.setItem('tv_admin_ok','1');

    // ===== Firebase init =====
    const firebaseConfig = { 
      apiKey: "AIzaSyAmmehhmU_ZKZ-rdnQ1e6PULO2bd1fYisg",
      authDomain: "team-vibe-1c3ea.firebaseapp.com",
      projectId: "team-vibe-1c3ea",
      storageBucket: "team-vibe-1c3ea.firebasestorage.app",
      messagingSenderId: "970729517323",
      appId: "1:970729517323:web:2f0034d39ca6c22702f20e"
    };
    let db, auth;
    try{ firebase.initializeApp(firebaseConfig); db=firebase.firestore(); auth=firebase.auth(); auth.signInAnonymously().catch(console.warn);}catch(e){console.warn('Firebase not initialized', e)}

    // ===== Firestore refs =====
    const gamesCol = () => db && db.collection('TeamVibe_games'); // case-sensitive
    const votesCol = (id) => db && gamesCol().doc(id).collection('votes');
    const votersLog = () => db && db.collection('voters_log'); // optional, for names table

    // ===== Provided 30-game list (admin can import) =====
    const GAMES_MASTER = [
      { name: "Drop the Pen in bottle using Mobile camera", url: "https://www.instagram.com/reel/DNP0ZztvnvZ/?igsh=M3h2M3Z5eGE2amlw" },
      { name: "Fan the Cup", url: "https://www.instagram.com/reel/DMvARSAz6qY/?igsh=MTh2cXp2M2hndW1rbA%3D%3D" },
      { name: "Strick standing Challenge", url: "https://www.instagram.com/reel/DNQEm21vdpB/?igsh=c2d2bTZyc255aTc=" },
      { name: "Hanger Transfer", url: "https://www.instagram.com/reel/DOBPgExCLgo/?igsh=MTJpazR0aHBjcjdibw==" },
      { name: "Multiple games in this Reel", url: "https://www.instagram.com/reel/DOGK-8KEskO/?igsh=MWl6cTg5cXhldmRibA==" },
      { name: "Do the Opposites", url: "https://www.instagram.com/reel/DOycseHE_NS/?igsh=eTI4ZTJ4YnRjYzM4" },
      { name: "Mission Bottle escape", url: "https://www.instagram.com/reel/DMfKLvcvbwF/?igsh=MXI0bDRicTV1ZmdlcA==" },
      { name: "Ball Gate", url: "https://www.instagram.com/reel/DLZLzUpy9JE/?igsh=MXg5dnYwaDk4ZDd0aQ==" },
      { name: "Catch it if you can", url: "https://www.instagram.com/reel/DMaaKp2TY1I/?igsh=MTk3MDYzNzA2cDI0bQ==" },
      { name: "Whats hiding in the cup?", url: "https://www.instagram.com/reel/DLZ39itSv5I/?igsh=MWkweXdpb2w2djFsNA==" },
      { name: "Spin and Drop the ball with bottle", url: "https://www.instagram.com/reel/DNFGKpSSJX1/?igsh=MTh0OXQ5OTd3bHUxMQ==" },
      { name: "Don't Clap At the Same Time", url: "https://www.instagram.com/reel/DK14cTbpnXc/?igsh=MWluNmtwYTU3ZHl0cA==" },
      { name: "Don't follow the hand", url: "https://www.instagram.com/reel/DLm-ckQSnaZ/?igsh=aTQxbW80cXo5eHF6" },
      { name: "Fill the cup with chocolate with papercup in both hand", url: "https://www.instagram.com/reel/DNlQfNvSZuO/?igsh=bHBxdzg3Nng1ZnNr" },
      { name: "Collect the cup with straw", url: "https://www.instagram.com/reel/DNqUyH0o_On/?igsh=MXFhNnF5ZGozdmo1NA==" },
      { name: "Flip the bottle", url: "https://youtube.com/shorts/JHU9ac717Tw?si=iho1cq6aS14VMxFz" },
      { name: "Blow the Cup with balloon", url: "https://www.instagram.com/reel/DNQYH_YSrvx/?igsh=MXRjYWlybHc5ZmV5bA==" },
      { name: "Tower Cup Challenge", url: "https://www.instagram.com/reel/DLZp5RYv7aY/?igsh=NTV6Z2hzcXBwNDF0" },
      { name: "Communication challenge", url: "https://youtube.com/shorts/RO0uJrbk1kc?si=c24-sWUk3MrDTOl2" },
      { name: "Don't Drop the Balloon", url: "https://youtube.com/shorts/N_xj-Zc762U?si=oJLotePSpF1qAzhC" },
      { name: "Head, Shoulder,Knees and pick the  item", url: "https://youtube.com/shorts/m_QEcL7dK7I?si=_6uZ3ArVQhS7lCj3" },
      { name: "Build the tower with Marshmallow", url: "https://youtu.be/7ZMuHZv47bQ?si=VMx2ypYdEXjBgfz9" },
      { name: "Goal the Ball", url: "https://youtube.com/shorts/bQYxwodUM2c?si=WlULSCE0Sh4vSUE-" },
      { name: "Hold the Paper with Straw", url: "https://youtube.com/shorts/mJgk6DLG7t0?si=fPG24w4lrdbg1nnG" },
      { name: "Build the pyramid with cup in head", url: "https://youtu.be/e-qehXWt36Y?si=QNK8HizfkpOFXmCE" },
      { name: "Cup and straw Balance", url: "https://youtube.com/shorts/PSDLwatlT2Q?si=jCuzv0y18d1uB3a6" },
      { name: "Hold the ball with Pen", url: "https://www.instagram.com/reel/DIog4Lnh-JV/?igsh=MWRiMGZkd2V1NWU3OQ==" },
      { name: "Spin and jump into your paper", url: "https://www.instagram.com/reel/DKPfi9ChQkg/?igsh=MTF2dWFwZ3NiMmMzMA==" },
      { name: "Transfer the ball with A4 paper", url: "https://www.instagram.com/reel/DMhVD5wRqa7/?igsh=emxtN2MzdzJ4ZDk4" },
      { name: "Catch the ball", url: "https://youtube.com/shorts/2cWj0XGiwGY?si=6J2kxLH1UWkUTM1y" }
    ];

    const palette = [ ['#7cf7ff','#95ff87'], ['#ffd166','#7cf7ff'], ['#ff7eb6','#ffd166'], ['#95ff87','#c4b5fd'] ];

    // ===== Helpers =====
    const grid = document.getElementById('reelsGrid');
    const topStats = document.getElementById('topStats');
    const adminPanel = document.getElementById('adminPanel');
    const DID_KEY='teamvibe_device_id';
    function getDeviceId(){ let id = localStorage.getItem(DID_KEY); if(!id){ id = Math.random().toString(36).slice(2)+Date.now().toString(36); localStorage.setItem(DID_KEY,id);} return id; }

    function parseUrl(u){
      try{ const url=new URL(u); const host=url.hostname.replace('www.','');
        if(host.includes('youtube.com')){ const v=url.searchParams.get('v'); if(v) return {type:'yt', id:v, open:url.toString()}; }
        if(host==='youtu.be'){ const id=url.pathname.slice(1); if(id) return {type:'yt', id, open:url.toString()}; }
        if(host.includes('instagram.com')){ return {type:'ig', open:url.toString(), embed:url.toString()}; }
        return {type:'unknown', open:url.toString()};
      }catch(e){ return {type:'invalid'} }
    }

    function reelCard(it, idx){
      const meta = parseUrl(it.url||'');
      const embed = (meta.type==='yt')
        ? `<iframe allow="autoplay; encrypted-media" src="https://www.youtube.com/embed/${meta.id}?rel=0" frameborder="0" allowfullscreen></iframe>`
        : (meta.type==='ig')
          ? `<blockquote class="instagram-media" data-instgrm-permalink="${it.url}" style="margin:0; height:100%; overflow:auto; background:#0a0f24;"></blockquote>`
          : `<div class="subtle" style="padding:8px">Unsupported link</div>`;
      const nameClr = 'nameColor'+((idx%4)+1);
      return `
        <article class="card" id="card_${it.id}">
          <h3 class="${nameClr}">${it.name}</h3>
          <div class="reel">${embed}</div>
          <div class="row">
            <input placeholder="Your name" id="name_${it.id}" />
            <button class="btn" data-act="vote" data-id="${it.id}" data-name="${encodeURIComponent(it.name)}">+1 Vote</button>
            <button class="btn ghost" data-act="open" data-url="${meta.open||''}">Open</button>
          </div>
        </article>`;
    }

    function renderTopBars(items){
      const max = Math.max(...items.map(x=>x.count||0), 1);
      topStats.innerHTML = items.map((it,i)=>{
        const pct = Math.round(((it.count||0)/max)*100);
        const c1 = palette[i%palette.length][0];
        const c2 = palette[i%palette.length][1];
        return `<div class="bar" style="--c1:${c1}; --c2:${c2}">
          <div class="name"><span class="badge" style="background:${c1}"></span>${it.name}</div>
          <div style="display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center">
            <div class="track"><div class="fill" style="background:linear-gradient(90deg, ${c1}, ${c2}); width:${pct}%"></div></div>
            <div class="count">${it.count||0}</div>
          </div>
        </div>`;
      }).join('');
    }

    function renderAdmin(items){
      if(!isAdmin){ adminPanel.style.display='none'; return; }
      adminPanel.style.display='block';
      adminPanel.innerHTML = `
        <div style="display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap">
          <div><b>Admin</b> ‚Äì Toggle <b>Featured</b> on any number of games. Users only see featured ones.</div>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <input id=\"newName\" placeholder=\"Game name\" style=\"padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0d1330; color:#e7ecff; min-width:220px\" />
            <input id=\"newUrl\" placeholder=\"Game URL (IG/YouTube)\" style=\"padding:8px 10px; border-radius:10px; border:1px solid rgba(255,255,255,.12); background:#0d1330; color:#e7ecff; min-width:320px\" />
            <button class=\"btn\" id=\"addGameBtn\">Add game</button>
            <button class=\"btn\" id=\"saveFeatured\">Save Featured</button>
            <button class=\"btn warn\" id=\"resetVotes\">Reset votes (featured)</button>
            <button class=\"btn ghost\" id=\"viewVoters\">View recent voters</button>
            <button class=\"btn ghost\" id=\"importGames\">Import games (add missing)</button>
          </div>
        </div>
        <div class=\"admGrid\" style=\"margin-top:10px\">${items.map(it=>`
          <div class=\"admRow\">
            <div style=\"display:flex; align-items:center; gap:10px\">
              <input type=\"checkbox\" class=\"featChk\" data-id=\"${it.id}\" ${it.featured?'checked':''} />
              <span>${it.name}</span>
            </div>
            <span class=\"subtle\">${it.count||0} votes</span>
          </div>`).join('')}</div>
        <div id=\"votersBox\" class=\"subtle\" style=\"margin-top:10px\"></div>
      `;
      // Add single game (admin quick add)
      document.getElementById('addGameBtn').onclick = async ()=>{
        const name = (document.getElementById('newName').value||'').trim();
        const url  = (document.getElementById('newUrl').value||'').trim();
        if(!name || !url) return alert('Enter both name and URL.');
        try{
          const q = await gamesCol().where('name','==', name).limit(1).get();
          if(!q.empty){ alert('A game with this name already exists.'); return; }
          await gamesCol().add({name, url, count:0, featured:false, createdAt: firebase.firestore.FieldValue.serverTimestamp()});
          document.getElementById('newName').value='';
          document.getElementById('newUrl').value='';
          alert('Game added.');
        }catch(e){ console.error(e); alert('Add failed. Check Firestore rules allow create.'); }
      };
      // Save featured (any number allowed)
      document.getElementById('saveFeatured').onclick = async ()=>{
        const chks = [...adminPanel.querySelectorAll('.featChk')];
        const selected = chks.filter(c=>c.checked).map(c=>c.getAttribute('data-id'));
        try{
          const batch = db.batch();
          items.forEach(it=>{ batch.update(gamesCol().doc(it.id), {featured: selected.includes(it.id)}); });
          await batch.commit();
          alert('Featured saved.');
        }catch(e){ console.error(e); alert('Saving failed.'); }
      };
      // Reset votes for featured (robust batching)
      document.getElementById('resetVotes').onclick = async ()=>{
        if(!confirm('Set counts to 0 and delete vote logs for ALL featured items?')) return;
        try{
          for(const it of items.filter(x=>x.featured)){
            let snap = await votesCol(it.id).limit(400).get();
            while(!snap.empty){
              const batch = db.batch();
              snap.forEach(doc=> batch.delete(votesCol(it.id).doc(doc.id)));
              await batch.commit();
              snap = await votesCol(it.id).limit(400).get();
            }
            await gamesCol().doc(it.id).update({count:0});
          }
          alert('Votes reset complete.');
        }catch(e){ console.error(e); alert('Reset failed. Ensure Firestore rules allow delete on /votes/* and update on games.'); }
      };
      // View voters (recent 50 for featured)
      document.getElementById('viewVoters').onclick = async ()=>{
        try{
          const ids = items.filter(x=>x.featured).map(x=>x.id);
          let list = [];
          for(const id of ids){
            const snap = await votesCol(id).orderBy('ts','desc').limit(50).get();
            snap.forEach(d=> list.push({game: items.find(x=>x.id===id)?.name || id, ...d.data()}));
          }
          list.sort((a,b)=> (b.ts?.seconds||0)-(a.ts?.seconds||0));
          const html = '<div><b>Recent voters</b></div>' + list.map(v=>`<div>‚Ä¢ ${v.voterName||'Anonymous'} <span class=\"subtle\">(${v.game})</span></div>`).join('');
          document.getElementById('votersBox').innerHTML = html || 'No votes yet.';
        }catch(e){ console.error(e); alert('Could not load voters'); }
      };
      // Import games (adds only missing by name)
      document.getElementById('importGames').onclick = async ()=>{
        if(!confirm('Add any missing items from the 30-game list?')) return;
        try{
          for(const g of GAMES_MASTER){
            const q = await gamesCol().where('name','==', g.name).limit(1).get();
            if(q.empty){ await gamesCol().add({name:g.name, url:g.url, count:0, featured:false, createdAt: firebase.firestore.FieldValue.serverTimestamp()}); }
          }
          alert('Import complete. Refresh to see new items.');
        }catch(e){ console.error(e); alert('Import failed. Ensure rules allow create temporarily.'); }
      };
    }

    function renderList(snap){
      const items=[]; snap.forEach(d=>{
        const raw=d.data();
        items.push({ id:d.id,
          name: raw?.name ?? raw?.Name ?? 'Untitled',
          url: raw?.url ?? raw?.URL ?? '',
          count: raw?.count ?? raw?.Count ?? 0,
          featured: !!(raw?.featured),
          createdAt: raw?.createdAt ?? raw?.Createdat ?? null
        });
      });

      const visible = isAdmin ? items : items.filter(x=>x.featured);
      if(visible.length===0){
        topStats.innerHTML='';
        grid.innerHTML = '<div class="subtle">No items are selected right now. Check back later.</div>';
      } else {
        // sort by count desc
        visible.sort((a,b)=> (b.count||0) - (a.count||0));
        renderTopBars(visible);
        grid.innerHTML='';
        visible.forEach((it,i)=> grid.insertAdjacentHTML('beforeend', reelCard(it,i)));
        if(window.instgrm && instgrm.Embeds) instgrm.Embeds.process();

        grid.querySelectorAll('button[data-act="open"]').forEach(b=> b.onclick = ()=> window.open(b.getAttribute('data-url'),'_blank'));
        grid.querySelectorAll('button[data-act="vote"]').forEach(b=>{
          b.onclick = function(){
            if(!db) return alert('Add Firebase config first.');
            const id = b.getAttribute('data-id');
            const gname = decodeURIComponent(b.getAttribute('data-name'));
            const name = (document.getElementById('name_'+id).value||'Anonymous').trim();
            if(!name) return alert('Please enter your name.');
            const device = getDeviceId();
            const voterKey = device; // one vote per reel per device
            votesCol(id).where('voterKey','==',voterKey).limit(1).get().then(q=>{
              if(!q.empty) return alert('You already voted for this one from this device. You can vote others.');
              return votesCol(id).add({voterName:name, voterKey, ts: firebase.firestore.FieldValue.serverTimestamp()})
                .then(()=> votersLog().add({voterName:name, gameId:id, gameName:gname, device, ts: firebase.firestore.FieldValue.serverTimestamp()}))
                .then(()=> gamesCol().doc(id).update({count: firebase.firestore.FieldValue.increment(1)}))
                .catch(e=>{ console.error(e); alert('Vote failed.'); });
            });
          }
        });
      }
      renderAdmin(items);
    }

    function subscribe(){
      if(!db){
        grid.innerHTML = '<div class="subtle">Connect Firebase to load items.</div>';
        return;
      }
      // games list
      gamesCol().onSnapshot(renderList, err=>console.error('Snapshot error', err));
      // live feed of last 10 votes (from voters_log)
      votesLive();
    }

    function votesLive(){
      const feedBody = document.getElementById('feedBody');
      try{
        votersLog().orderBy('ts','desc').limit(10).onSnapshot(snap=>{
          const arr=[]; snap.forEach(d=> arr.push(d.data()));
          if(arr.length===0){ feedBody.textContent='No votes yet.'; return; }
          feedBody.innerHTML = arr.map(v=>`<div>‚Ä¢ <b>${v.voterName||'Anonymous'}</b> voted <i>${v.gameName||v.gameId}</i></div>`).join('');
        }, err=>{ console.warn('voters_log read failed', err); });
      }catch(e){ console.warn('Live feed not available', e); }
    }

    // confetti
    (function(){ const orbit=document.getElementById('orbit'); const colors=['#7cf7ff','#95ff87','#ffd166','#ff7eb6','#c4b5fd']; for(let i=0;i<40;i++){ const d=document.createElement('div'); d.className='orb'; d.style.left=Math.random()*100+'vw'; d.style.top=(-10-Math.random()*40)+'vh'; d.style.background=colors[Math.floor(Math.random()*colors.length)]; const dx=(Math.random()*60-30)+'vw'; d.style.setProperty('--dx',dx); d.style.animationDuration=(6+Math.random()*10)+'s'; orbit.appendChild(d);} })();

    subscribe();
  })();
  </script>
</body>
</html>
